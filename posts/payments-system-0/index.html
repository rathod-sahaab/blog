<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Building a Modular and Extensible Payments System [0] | Everything Engineering</title>
<meta name=keywords content="backend,nodejs,typescript,systems-design,low-level-design"><meta name=description content="Learn how to structure your payments service with modularity in mind, allowing for easy integration and scalability as your application grows. Learn the art of building an extensible foundation that can adapt to changing business needs, ensuring robustness and agility, to, at the end of the day, maximize profit."><meta name=author content="Abhay"><link rel=canonical href=https://abhay.rs/blog/posts/payments-system-0/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/blog/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://abhay.rs/blog/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://abhay.rs/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://abhay.rs/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://abhay.rs/blog/apple-touch-icon.png><link rel=mask-icon href=https://abhay.rs/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css integrity=sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js integrity=sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})'></script><meta property="og:title" content="Building a Modular and Extensible Payments System [0]"><meta property="og:description" content="Learn how to structure your payments service with modularity in mind, allowing for easy integration and scalability as your application grows. Learn the art of building an extensible foundation that can adapt to changing business needs, ensuring robustness and agility, to, at the end of the day, maximize profit."><meta property="og:type" content="article"><meta property="og:url" content="https://abhay.rs/blog/posts/payments-system-0/"><meta property="og:image" content="https://abhay.rs/blog/posts/payments-system-0/posts/payments-system-0/thumbnail.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-17T00:00:00+00:00"><meta property="og:site_name" content="Everything Engineering"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://abhay.rs/blog/posts/payments-system-0/posts/payments-system-0/thumbnail.png"><meta name=twitter:title content="Building a Modular and Extensible Payments System [0]"><meta name=twitter:description content="Learn how to structure your payments service with modularity in mind, allowing for easy integration and scalability as your application grows. Learn the art of building an extensible foundation that can adapt to changing business needs, ensuring robustness and agility, to, at the end of the day, maximize profit."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://abhay.rs/blog/posts/"},{"@type":"ListItem","position":3,"name":"Building a Modular and Extensible Payments System [0]","item":"https://abhay.rs/blog/posts/payments-system-0/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Building a Modular and Extensible Payments System [0]","name":"Building a Modular and Extensible Payments System [0]","description":"Learn how to structure your payments service with modularity in mind, allowing for easy integration and scalability as your application grows. Learn the art of building an extensible foundation that can adapt to changing business needs, ensuring robustness and agility, to, at the end of the day, maximize profit.","keywords":["backend","nodejs","typescript","systems-design","low-level-design"],"articleBody":"Foreword Skip to requirements\nThis is a story of technical debt and its inevitable payoff. It’s not a cautionary tale and let’s not take away that technical debt is bad, technical debt is much like financial debt. In fact, our modern economy relies heavily on various forms of debt. The key is managing and repaying debt effectively, tell that to the governments around the world :P\nLet’s start from the middle In my day job at Tealfeed, we added a revenue-generating feature, with stripe as the payment gateway. Everything worked well, and we lived happily ever after. Right? Wrong! First, we added a few more features and then a few more payment gateways all in good faith and name of business needs, and then, the code was, to put it lightly, BLOATED. Mathematically speaking the code scaled with the order of A × B (cross product) A being the number of features and B being the number of payment gateways.\nA few hair-pulling problems arose due to this, concoction of features and payment gateways.\nBugs fixed once in payment logic still occurred somewhere overlooked. Payment logic polluted the business logic allowing for blunder-full programming experience. Code for resolution on which payment to use had to be done in multiple places. So business agility went out the window. Each of our feature’s database models contained information regarding payment voiding the much beloved SRP(Single Responsibility Principle) from SOLID. Not all features had all the payment info as adding the payment info code was a manual task prone to human error. Made the db models bloated, and fetch code where payment status had to be checked either in query or in code. Our analytics capabilities were limited due to payment related data being distributed. Ghost purchases: as the payment info was stored in feature models/tables we had to create a ghost purchase just to store payment info which were marked successful in some way. But, If payment was not successful the purchases still lingered, hence, ghost purchases. All our queries had to account for that. class Call { ...callData, status: 'pending' | 'success' | 'failure'; amount: number, // TODO: string currency: ICurrencyCode, clientIp: string, country: string | null, paymentGateway: 'stripe' | 'phonepe'; paymentGatewayTransactionId: string; } class Package { ...packageData, status: 'pending' | 'success' | 'failure'; amount: number, // TODO: string currency: ICurrencyCode, paymentGateway: 'stripe' | 'phonepe'; paymentGatewayTransactionId: string; } class Webinar { ...webinarData, status: 'pending' | 'success' | 'failure'; amount: number, // TODO: string currency: ICurrencyCode, paymentGateway: 'stripe' | 'phonepe'; paymentGatewayTransactionId: string; } As you can see there’s violation of several S.O.L.I.D Principles at once leading to a lot of pain, and we don’t want that.\nWhat do we want? Our payments service/module\nShould centralize all of the payment gateway selection logic. Be open to the addition of new payment gateways with minimal effort. Should not depend on the features and be agnostic of them in a functional sense. Should not depend on payment gateway specific features (vendor workaround code is not fun). Should centralize all the payments-related data No ghost purchases. Data Any good back-end feature design starts with the data, it’s data structures and algorithms and not the other way around, so let’s build up our data models. There are two major parts to our payments data, Orders and Transactions.\nOrder: is like a shopping cart, it remembers what you are trying to buy. Transactions: these store the data about attempts of payments for a particular order. An Order can have multiple Transactions, in case the customer retries failed payments, but, in order(pun intended) to state the obvious only one successful Transaction.\nOrder First things first, we need to know\nwho is buying. what is being bought? how much is to be paid? and from whom. ‘Whom’ can be technically optional as the product contains data about the seller but it makes analytics a lot easier. class Order { // who buyer: User; // what productType: ProductTableName; // 'call_type' | 'package' | 'webinar' productId: Id; // how much amount: number; // TODO: string currency: ICurrencyCode; // 'INR' | 'USD', // whom seller: User; } Then we need to know whether this purchase was successful, failed, other little goody statuses, and which was the successful transaction if any.\nclass Order { ...prev, status: 'created' | 'paid' | 'canceled' | 'refunded' | 'failed'; successfulTransaction?: TransactionId; } Extra data: some of the products like calls also require specific data like start \u0026 end times. Which is not shared in other products. This was earlier stored in either ghost purchases or stripe meta-data. But as the requirements were ’no ghost purchases’ and no payment gateway-specific features we need to store that data too. Hence order has a meta-data field to store.\nclass Order { ...prev, data: any; } This data is generally called upon when the payment gateway indicates a successful payment.\nTransaction These store the data about attempts of payments for a particular order.\nParent Order and Status We need to know which order this transaction belongs to, and what’s the status of the transaction.\nclass Transaction { order: Order; status: 'created' | 'paid' | 'failed'; } Amount We also need to store the actual amount paid for the transaction by the user. This is more for the case of international transactions, where the amount of the order would be in dollars but the actual amount received by us will be INR(Rupee) as paid by the customer.\nThis might also depend on the payment gateway, as Stripe will charge users in dollars and Phonepe might charge users in rupees.\nclass Transaction { ...prev, amount: number; // TODO: string currency: ICurrencyCode; // 'INR' | 'USD', conversionRate: // just for analytics } This will be crucial for refunds as conversion rates may change and the actual amount refunded might be less or greater than the amount spent by the user if we go by the amount stored in order only, which maps 1-to-1 with the cost of services.\nPayment Gateways As we have already made quite a big deal about payment gateways it’s obvious we have to store those, to track where the payment came from. This makes sense at the transaction level because the same order can be tried to be paid by different PGs depending on payment method (cards/UPI etc.), and failures.\nTo reiterate each payment attempt will have a separate transaction.\nWe store the PG through which the payment came and also the Transaction ID so we can look it up on PG’s console.\nclass Transaction { ...prev, paymentGateway: 'stripe' | 'phonepe' | 'razorpay'; paymentGatewayTransactionId: string; } Refunds We also need to track refunds somehow, and due to my bias towards not mutating the data I can #functional-programming. Each refund also creates a new transaction because as you can imagine refunds can fail too (due variety of factors). Also, there might be future requests for a partial refund feature. All in all, there was a significant overlap between normal transactions and refunds. So we just add another field to determine whether it’s a payment transaction or a refund transaction.\nclass Transaction { ...prev, type: 'payment' | 'refund'; } So that was all the data regarding receiving payments. To\nCompiled Mostly order is used for our application flows, and transactions are just to store data for invoicing, analytics and debugging purposes.\nclass Order { // who buyer: User; // what productType: ProductTableName; // 'call_type' | 'package' | 'webinar' productId: Id; // how much amount: number; // TODO: string currency: ICurrencyCode; // 'INR' | 'USD', // whom seller: User; // status status: 'created' | 'paid' | 'canceled' | 'refunded' | 'failed'; successfulTransaction?: TransactionId; // meta-data data: any; } class Transaction { order: Order; status: 'created' | 'paid' | 'failed'; amount: number; // TODO: string currency: ICurrencyCode; // 'INR' | 'USD', conversionRate: // just for analytics // payment gateway related information paymentGateway: 'stripe' | 'phonepe' | 'razorpay'; paymentGatewayTransactionId: string; // refund or payment type: 'payment' | 'refund'; } You can come up with actual implementation of these models as they will vary for your stack and needs. But, the important thing is to have a clear idea of what data you need to store and how it will be used.\nStay tuned for the actual code, the algorithms to our data structures in the next part.\n","wordCount":"1380","inLanguage":"en","image":"https://abhay.rs/blog/posts/payments-system-0/posts/payments-system-0/thumbnail.png","datePublished":"2023-09-17T00:00:00Z","dateModified":"2023-09-17T00:00:00Z","author":{"@type":"Person","name":"Abhay"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://abhay.rs/blog/posts/payments-system-0/"},"publisher":{"@type":"Organization","name":"Everything Engineering","logo":{"@type":"ImageObject","url":"https://abhay.rs/blog/favicon.svg"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://abhay.rs/blog accesskey=h title="Everything Engineering (Alt + H)"><svg style="margin-bottom:-.3em;border-radius:0" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs" width="30" height="30"><svg width="30" height="30" viewBox="0 0 99.682 99.682" xmlns="http://www.w3.org/2000/svg"><path d="M0 10.807v78.19h46.972V73.438H15.657V57.731h23.486v-15.61H15.657V26.416h31.315v-15.61zm99.682.0v78.19H52.71V73.438h31.315V57.731H60.539v-15.61h23.486V26.416H52.71v-15.61z" fill="currentcolor"/></svg><style>@media(prefers-color-scheme:light){:root{filter:none}}</style></svg>Everything Engineering</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://abhay.rs/blog/series/ title=series><span>series</span></a></li><li><a href=https://abhay.rs/blog/tags/ title=tags><span>tags</span></a></li><li><a href=https://abhay.rs title=abhay.rs><span>abhay.rs</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://abhay.rs/blog>Home</a>&nbsp;»&nbsp;<a href=https://abhay.rs/blog/posts/>Posts</a></div><h1 class=post-title>Building a Modular and Extensible Payments System [0]</h1><div class=post-description>Learn how to structure your payments service with modularity in mind, allowing for easy integration and scalability as your application grows. Learn the art of building an extensible foundation that can adapt to changing business needs, ensuring robustness and agility, to, at the end of the day, maximize profit.</div><div class=post-meta><span title='2023-09-17 00:00:00 +0000 UTC'>September 17, 2023</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1380 words&nbsp;·&nbsp;Abhay&nbsp;|&nbsp;<a href=https://github.com/rathod-sahaab/blog/edit/dev/content/posts/payments-system-0/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://abhay.rs/blog/posts/payments-system-0/thumbnail.png alt="Thumbnail: Server with various payment gateways"><p>A Server with various payment gateways</p></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#foreword>Foreword</a></li><li><a href=#lets-start-from-the-middle>Let&rsquo;s start from the middle</a></li><li><a href=#what-do-we-want>What do we want?</a></li><li><a href=#data>Data</a><ul><li><a href=#order>Order</a></li><li><a href=#transaction>Transaction</a></li><li><a href=#compiled>Compiled</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=foreword>Foreword<a hidden class=anchor aria-hidden=true href=#foreword>#</a></h2><p><a href=#what-do-we-want>Skip to requirements</a></p><p>This is a story of technical debt and its inevitable payoff. It&rsquo;s not a cautionary tale and let&rsquo;s not take away that technical debt is bad, technical debt is much like financial debt. In fact, our modern economy relies heavily on various forms of debt. The key is managing and repaying debt effectively, tell that to the governments around the world :P</p><h2 id=lets-start-from-the-middle>Let&rsquo;s start from the middle<a hidden class=anchor aria-hidden=true href=#lets-start-from-the-middle>#</a></h2><p>In my day job at <a href=https://tealfeed.com>Tealfeed</a>, we added a revenue-generating feature, with <strong>stripe</strong> as the payment gateway. Everything worked well, and we lived happily ever after. Right? Wrong! First, we added a few more features and then a few more payment gateways all in good faith and name of business needs, and then, the code was, to put it lightly, BLOATED. Mathematically speaking the code scaled with the order of <code>A × B</code> <em>(cross product)</em> <code>A</code> being the number of features and <code>B</code> being the number of payment gateways.</p><p>A few hair-pulling problems arose due to this, concoction of features and payment gateways.</p><ol><li>Bugs fixed once in payment logic still occurred somewhere overlooked.</li><li>Payment logic polluted the business logic allowing for blunder-full programming experience.</li><li>Code for resolution on which payment to use had to be done in multiple places. So business agility went out the window.</li><li>Each of our feature&rsquo;s database models contained information regarding payment voiding the much beloved SRP(Single Responsibility Principle) from SOLID.<ol><li>Not all features had all the payment info as adding the payment info code was a manual task prone to human error.</li><li>Made the db models bloated, and fetch code where payment status had to be checked either in query or in code.</li><li>Our analytics capabilities were limited due to payment related data being distributed.</li></ol></li><li>Ghost purchases: as the payment info was stored in feature models/tables we had to create a ghost purchase just to store payment info which were marked successful in some way. But, If payment was not successful the purchases still lingered, hence, <strong>ghost</strong> purchases. All our queries had to account for that.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Call</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span><span class=nx>callData</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;pending&#39;</span> <span class=o>|</span> <span class=s1>&#39;success&#39;</span> <span class=o>|</span> <span class=s1>&#39;failure&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>amount</span>: <span class=kt>number</span><span class=p>,</span> <span class=c1>// TODO: string 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>currency</span>: <span class=kt>ICurrencyCode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>clientIp</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>country</span>: <span class=kt>string</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>paymentGateway</span><span class=o>:</span> <span class=s1>&#39;stripe&#39;</span> <span class=o>|</span> <span class=s1>&#39;phonepe&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>paymentGatewayTransactionId</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Package</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span><span class=nx>packageData</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;pending&#39;</span> <span class=o>|</span> <span class=s1>&#39;success&#39;</span> <span class=o>|</span> <span class=s1>&#39;failure&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>amount</span>: <span class=kt>number</span><span class=p>,</span> <span class=c1>// TODO: string 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>currency</span>: <span class=kt>ICurrencyCode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>paymentGateway</span><span class=o>:</span> <span class=s1>&#39;stripe&#39;</span> <span class=o>|</span> <span class=s1>&#39;phonepe&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>paymentGatewayTransactionId</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Webinar</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span><span class=nx>webinarData</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;pending&#39;</span> <span class=o>|</span> <span class=s1>&#39;success&#39;</span> <span class=o>|</span> <span class=s1>&#39;failure&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>amount</span>: <span class=kt>number</span><span class=p>,</span> <span class=c1>// TODO: string 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>currency</span>: <span class=kt>ICurrencyCode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>paymentGateway</span><span class=o>:</span> <span class=s1>&#39;stripe&#39;</span> <span class=o>|</span> <span class=s1>&#39;phonepe&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>paymentGatewayTransactionId</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As you can see there&rsquo;s violation of several <strong>S.O.L.I.D</strong> Principles at once leading to a lot of pain, and we don&rsquo;t want that.</p><h2 id=what-do-we-want>What do we want?<a hidden class=anchor aria-hidden=true href=#what-do-we-want>#</a></h2><p>Our payments service/module</p><ol><li>Should centralize all of the payment gateway selection logic.</li><li>Be open to the addition of new payment gateways with minimal effort.</li><li>Should not depend on the features and be agnostic of them in a functional sense.</li><li>Should not depend on payment gateway specific features <em>(vendor workaround code is not fun)</em>.</li><li>Should centralize all the payments-related data</li><li>No ghost purchases.</li></ol><h2 id=data>Data<a hidden class=anchor aria-hidden=true href=#data>#</a></h2><p>Any good back-end feature design starts with the data, it&rsquo;s <em>data structures and algorithms</em> and not the other way around, so let&rsquo;s build up our data models. There are two major parts to our payments data, Orders and Transactions.</p><ol><li>Order: is like a shopping cart, it remembers what you are trying to buy.</li><li>Transactions: these store the data about attempts of payments for a particular order.</li></ol><p>An Order can have multiple Transactions, in case the customer retries failed payments, but, in order(pun intended) to state the obvious only one successful Transaction.</p><h3 id=order>Order<a hidden class=anchor aria-hidden=true href=#order>#</a></h3><p>First things first, we need to know</p><ol><li>who is buying.</li><li>what is being bought?</li><li>how much is to be paid?</li><li>and from whom.
&lsquo;Whom&rsquo; can be technically optional as the product contains data about the seller but it makes analytics a lot easier.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Order</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// who
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>buyer</span>: <span class=kt>User</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// what
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>productType</span>: <span class=kt>ProductTableName</span><span class=p>;</span> <span class=c1>// &#39;call_type&#39; | &#39;package&#39; | &#39;webinar&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>productId</span>: <span class=kt>Id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// how much
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>amount</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// TODO: string
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>currency</span>: <span class=kt>ICurrencyCode</span><span class=p>;</span> <span class=c1>// &#39;INR&#39; | &#39;USD&#39;,
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// whom
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>seller</span>: <span class=kt>User</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Then we need to know whether this purchase was successful, failed, other little goody statuses, and which was the successful transaction if any.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Order</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span><span class=nx>prev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;created&#39;</span> <span class=o>|</span> <span class=s1>&#39;paid&#39;</span> <span class=o>|</span> <span class=s1>&#39;canceled&#39;</span> <span class=o>|</span> <span class=s1>&#39;refunded&#39;</span> <span class=o>|</span> <span class=s1>&#39;failed&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>successfulTransaction?</span>: <span class=kt>TransactionId</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Extra data: some of the products like calls also require specific data like start & end times. Which is not shared in other products. This was earlier stored in either ghost purchases or stripe meta-data. But as the requirements were &rsquo;no ghost purchases&rsquo; and no payment gateway-specific features we need to store that data too. Hence order has a meta-data field to store.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Order</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span><span class=nx>prev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span>: <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This data is generally called upon when the payment gateway indicates a successful payment.</p><h3 id=transaction>Transaction<a hidden class=anchor aria-hidden=true href=#transaction>#</a></h3><p>These store the data about attempts of payments for a particular order.</p><h4 id=parent-order-and-status>Parent Order and Status<a hidden class=anchor aria-hidden=true href=#parent-order-and-status>#</a></h4><p>We need to know which order this transaction belongs to, and what&rsquo;s the status of the transaction.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Transaction</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>order</span>: <span class=kt>Order</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;created&#39;</span> <span class=o>|</span> <span class=s1>&#39;paid&#39;</span> <span class=o>|</span> <span class=s1>&#39;failed&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=amount>Amount<a hidden class=anchor aria-hidden=true href=#amount>#</a></h4><p>We also need to store the actual amount paid for the transaction by the user. This is more for the case of international transactions, where the amount of the order would be in dollars but the actual amount received by us will be INR(Rupee) as paid by the customer.</p><p>This might also depend on the payment gateway, as Stripe will charge users in dollars and Phonepe might charge users in rupees.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Transaction</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span><span class=nx>prev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>amount</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// TODO: string
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>currency</span>: <span class=kt>ICurrencyCode</span><span class=p>;</span> <span class=c1>// &#39;INR&#39; | &#39;USD&#39;,
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>conversionRate</span><span class=o>:</span> <span class=c1>// just for analytics
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p><strong>This will be crucial for refunds</strong> as conversion rates may change and the actual amount refunded might be less or greater than the amount spent by the user if we go by the amount stored in order only, which maps 1-to-1 with the cost of services.</p><h4 id=payment-gateways>Payment Gateways<a hidden class=anchor aria-hidden=true href=#payment-gateways>#</a></h4><p>As we have already made quite a big deal about payment gateways it&rsquo;s obvious we have to store those, to track where the payment came from. This makes sense at the transaction level because the same order can be tried to be paid by different PGs depending on payment method (cards/UPI etc.), and failures.</p><p>To reiterate each payment attempt will have a separate transaction.</p><p>We store the PG through which the payment came and also the Transaction ID so we can look it up on PG&rsquo;s console.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Transaction</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span><span class=nx>prev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>paymentGateway</span><span class=o>:</span> <span class=s1>&#39;stripe&#39;</span> <span class=o>|</span> <span class=s1>&#39;phonepe&#39;</span> <span class=o>|</span> <span class=s1>&#39;razorpay&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>paymentGatewayTransactionId</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=refunds>Refunds<a hidden class=anchor aria-hidden=true href=#refunds>#</a></h4><p>We also need to track refunds somehow, and due to my bias towards not mutating the data I can #functional-programming. Each refund also creates a new transaction because as you can imagine refunds can fail too (due variety of factors). Also, there might be future requests for a partial refund feature.
All in all, there was a significant overlap between normal transactions and refunds. So we just add another field to determine whether it&rsquo;s a <code>payment</code> transaction or a <code>refund</code> transaction.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Transaction</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span><span class=nx>prev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;payment&#39;</span> <span class=o>|</span> <span class=s1>&#39;refund&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>So that was all the data regarding receiving payments. To</p><h3 id=compiled>Compiled<a hidden class=anchor aria-hidden=true href=#compiled>#</a></h3><p>Mostly order is used for our application flows, and transactions are just to store data for invoicing, analytics and debugging purposes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Order</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// who
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>buyer</span>: <span class=kt>User</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// what
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>productType</span>: <span class=kt>ProductTableName</span><span class=p>;</span> <span class=c1>// &#39;call_type&#39; | &#39;package&#39; | &#39;webinar&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>productId</span>: <span class=kt>Id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// how much
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>amount</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// TODO: string
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>currency</span>: <span class=kt>ICurrencyCode</span><span class=p>;</span> <span class=c1>// &#39;INR&#39; | &#39;USD&#39;,
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// whom
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>seller</span>: <span class=kt>User</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// status
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;created&#39;</span> <span class=o>|</span> <span class=s1>&#39;paid&#39;</span> <span class=o>|</span> <span class=s1>&#39;canceled&#39;</span> <span class=o>|</span> <span class=s1>&#39;refunded&#39;</span> <span class=o>|</span> <span class=s1>&#39;failed&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>successfulTransaction?</span>: <span class=kt>TransactionId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// meta-data
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>data</span>: <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Transaction</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>order</span>: <span class=kt>Order</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;created&#39;</span> <span class=o>|</span> <span class=s1>&#39;paid&#39;</span> <span class=o>|</span> <span class=s1>&#39;failed&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>amount</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// TODO: string
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>currency</span>: <span class=kt>ICurrencyCode</span><span class=p>;</span> <span class=c1>// &#39;INR&#39; | &#39;USD&#39;,
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>conversionRate</span><span class=o>:</span> <span class=c1>// just for analytics
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// payment gateway related information
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>paymentGateway</span><span class=o>:</span> <span class=s1>&#39;stripe&#39;</span> <span class=o>|</span> <span class=s1>&#39;phonepe&#39;</span> <span class=o>|</span> <span class=s1>&#39;razorpay&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>paymentGatewayTransactionId</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// refund or payment
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;payment&#39;</span> <span class=o>|</span> <span class=s1>&#39;refund&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>You can come up with actual implementation of these models as they will vary for your stack and needs. But, the important thing is to have a clear idea of what data you need to store and how it will be used.</p><p>Stay tuned for the actual code, the algorithms to our data structures in the next part.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://abhay.rs/blog/tags/backend/>backend</a></li><li><a href=https://abhay.rs/blog/tags/nodejs/>nodejs</a></li><li><a href=https://abhay.rs/blog/tags/typescript/>typescript</a></li><li><a href=https://abhay.rs/blog/tags/systems-design/>systems-design</a></li><li><a href=https://abhay.rs/blog/tags/low-level-design/>low-level-design</a></li></ul><nav class=paginav><a class=prev href=https://abhay.rs/blog/posts/backend-intermediate-0/><span class=title>« Prev</span><br><span>Bloom filters, the magic of O(1) indexes with rust</span>
</a><a class=next href=https://abhay.rs/blog/posts/maths-from-chaos-0/><span class=title>Next »</span><br><span>Bouncing Bead - Maths from chaos [0]</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Building a Modular and Extensible Payments System [0] on x" href="https://x.com/intent/tweet/?text=Building%20a%20Modular%20and%20Extensible%20Payments%20System%20%5b0%5d&amp;url=https%3a%2f%2fabhay.rs%2fblog%2fposts%2fpayments-system-0%2f&amp;hashtags=backend%2cnodejs%2ctypescript%2csystems-design%2clow-level-design"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Building a Modular and Extensible Payments System [0] on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fabhay.rs%2fblog%2fposts%2fpayments-system-0%2f&amp;title=Building%20a%20Modular%20and%20Extensible%20Payments%20System%20%5b0%5d&amp;summary=Building%20a%20Modular%20and%20Extensible%20Payments%20System%20%5b0%5d&amp;source=https%3a%2f%2fabhay.rs%2fblog%2fposts%2fpayments-system-0%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Building a Modular and Extensible Payments System [0] on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fabhay.rs%2fblog%2fposts%2fpayments-system-0%2f&title=Building%20a%20Modular%20and%20Extensible%20Payments%20System%20%5b0%5d"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Building a Modular and Extensible Payments System [0] on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fabhay.rs%2fblog%2fposts%2fpayments-system-0%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Building a Modular and Extensible Payments System [0] on whatsapp" href="https://api.whatsapp.com/send?text=Building%20a%20Modular%20and%20Extensible%20Payments%20System%20%5b0%5d%20-%20https%3a%2f%2fabhay.rs%2fblog%2fposts%2fpayments-system-0%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Building a Modular and Extensible Payments System [0] on telegram" href="https://telegram.me/share/url?text=Building%20a%20Modular%20and%20Extensible%20Payments%20System%20%5b0%5d&amp;url=https%3a%2f%2fabhay.rs%2fblog%2fposts%2fpayments-system-0%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Building a Modular and Extensible Payments System [0] on ycombinator" href="https://news.ycombinator.com/submitlink?t=Building%20a%20Modular%20and%20Extensible%20Payments%20System%20%5b0%5d&u=https%3a%2f%2fabhay.rs%2fblog%2fposts%2fpayments-system-0%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://abhay.rs/blog>Everything Engineering</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>